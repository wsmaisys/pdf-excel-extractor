<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üìÑ Semantic PDF Extraction Agent</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px 20px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.95;
      }

      .content {
        padding: 40px;
      }

      .upload-section {
        margin-bottom: 40px;
      }

      .upload-box {
        border: 3px dashed #667eea;
        border-radius: 8px;
        padding: 18px 20px;
        min-height: 120px;
        text-align: center;
        background: #f8f9ff;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .upload-box:hover {
        background: #f0f1ff;
        border-color: #764ba2;
      }

      .upload-box.dragover {
        background: #e8e9ff;
        border-color: #764ba2;
        transform: scale(1.02);
      }

      .upload-box input[type="file"] {
        display: none;
      }

      .upload-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        cursor: pointer;
      }

      .upload-icon {
        font-size: 2.2em;
      }

      .upload-text {
        font-size: 1em;
        color: #667eea;
        font-weight: 600;
      }

      .upload-subtext {
        font-size: 0.85em;
        color: #999;
      }

      .upload-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 9px 20px;
        border-radius: 6px;
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 12px;
      }

      .upload-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }

      .upload-button:active {
        transform: translateY(0);
      }

      .job-status {
        background: #f0f7ff;
        border-left: 4px solid #667eea;
        padding: 15px;
        border-radius: 6px;
        margin: 20px 0;
        font-weight: 600;
        display: none;
      }

      .job-status.show {
        display: block;
      }

      .confidence-score {
        background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
        border-left: 4px solid #4caf50;
        padding: 20px;
        margin: 20px 0;
        border-radius: 6px;
        font-weight: 600;
        display: none;
      }

      .confidence-score.show {
        display: block;
        animation: slideIn 0.5s ease;
      }

      .confidence-score.yellow {
        background: linear-gradient(135deg, #fff9e6 0%, #fffbf0 100%);
        border-left-color: #ffa500;
      }

      .confidence-score.red {
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        border-left-color: #ff6b6b;
      }

      .confidence-score.green {
        background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
        border-left-color: #4caf50;
      }

      .confidence-value {
        font-size: 2em;
        font-weight: 700;
        margin: 10px 0;
      }

      .confidence-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
        font-size: 0.9em;
      }

      .confidence-detail {
        background: rgba(255, 255, 255, 0.7);
        padding: 12px;
        border-radius: 6px;
      }

      .logs-section {
        background: #1e1e1e;
        color: #e0e0e0;
        padding: 15px;
        border-radius: 6px;
        margin: 20px 0;
        display: none;
      }

      .logs-section.show {
        display: block;
      }

      #logs {
        background: #1e1e1e;
        color: #4ec9b0;
        padding: 15px;
        border-radius: 6px;
        max-height: 300px;
        overflow-y: auto;
        font-family: "Monaco", "Courier New", monospace;
        font-size: 0.9em;
        line-height: 1.5;
      }

      .table-section {
        margin-top: 30px;
      }

      .table-section h3 {
        margin-bottom: 20px;
        font-size: 1.5em;
        color: #333;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #667eea;
      }

      td {
        padding: 12px;
        border-bottom: 1px solid #e0e0e0;
      }

      tr:nth-child(even) {
        background-color: #f9f9f9;
      }

      tr:hover {
        background-color: #f0f1ff;
        transition: background-color 0.2s ease;
      }

      .download-link {
        display: inline-block;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 600;
        transition: all 0.3s ease;
        margin-left: 15px;
      }

      .download-link:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
      }

      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 1.8em;
        }

        .content {
          padding: 20px;
        }

        .confidence-details {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìÑ Semantic PDF Extraction Agent</h1>
        <p>‚ú® Convert unstructured PDFs to structured Excel with AI-powered extraction</p>
        <div style="margin-top:12px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
          <a href="/static/metrics.html" class="download-link" style="background: rgba(255,255,255,0.08); color: white; text-decoration: none;">üìä Metrics Guide</a>
          <a href="/static/api.html" class="download-link" style="background: rgba(255,255,255,0.08); color: white; text-decoration: none;">üìö API Docs</a>
        </div>
      </div>

      <div class="content">
        <div class="upload-section">
          <div class="upload-box" id="uploadBox">
            <label for="file" class="upload-label">
              <div class="upload-icon">üìÅ</div>
              <div class="upload-text">Drop your PDF here or click to browse</div>
              <div class="upload-subtext">(Only digital PDFs are supported)</div>
              <input type="file" id="file" name="file" accept="application/pdf" />
              <button type="button" class="upload-button">üöÄ Choose PDF</button>
            </label>
          </div>
        </div>

        <div class="job-status" id="job"></div>

        <div class="confidence-score" id="confidenceScore"></div>

        <div class="logs-section" id="logsSection">
          <div style="margin-bottom: 10px; font-weight: 600;">üîç Processing Logs:</div>
          <pre id="logs"></pre>
        </div>

        <div class="table-section" id="tableContainer"></div>
      </div>
    </div>

    <script>
      const uploadBox = document.getElementById("uploadBox");
      const form = document.querySelector("label");
      const fileInput = document.getElementById("file");
      const logs = document.getElementById("logs");
      const logsSection = document.getElementById("logsSection");
      const jobDiv = document.getElementById("job");
      const tableContainer = document.getElementById("tableContainer");
      const confidenceScore = document.getElementById("confidenceScore");

      // Drag and drop
      uploadBox.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadBox.classList.add("dragover");
      });

      uploadBox.addEventListener("dragleave", () => {
        uploadBox.classList.remove("dragover");
      });

      uploadBox.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadBox.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          handleUpload();
        }
      });

      // Button click
      document.querySelector(".upload-button").addEventListener("click", (e) => {
        e.preventDefault();
        fileInput.click();
      });

      fileInput.addEventListener("change", handleUpload);

      async function handleUpload() {
        const f = fileInput.files[0];
        if (!f) return alert("üö® Please select a PDF file");

        const fd = new FormData();
        fd.append("file", f);

        jobDiv.classList.add("show");
        jobDiv.innerHTML = '<div class="spinner"></div> Uploading and processing...';
        logsSection.classList.add("show");
        logs.innerText = "‚è≥ Initializing...\n";
        tableContainer.innerHTML = "";
        confidenceScore.classList.remove("show");

        try {
          const res = await fetch("/upload", { method: "POST", body: fd });
          const j = await res.json();

          const id = j.job_id;
          jobDiv.innerHTML = `‚úÖ Job ID: <strong>${id}</strong>`;

          // Poll status
          const iv = setInterval(async () => {
            try {
              const s = await (await fetch("/status/" + id)).json();

              // Update logs
              let logText = s.logs.map(log => {
                if (log.includes("‚úì") || log.includes("Successfully")) return `‚úÖ ${log}`;
                if (log.includes("Detecting")) return `üîç ${log}`;
                if (log.includes("Sending")) return `üì§ ${log}`;
                if (log.includes("Waiting")) return `‚è≥ ${log}`;
                if (log.includes("Extracted")) return `üìä ${log}`;
                if (log.includes("Error") || log.includes("error")) return `üö® ${log}`;
                return log;
              }).join("\n");
              logs.innerText = logText;
              logs.scrollTop = logs.scrollHeight;

              // Display confidence score when done
              if (s.status === "done" && s.eval_result) {
                const eval_result = s.eval_result;
                const confidence = (eval_result.avg_bleu + eval_result.coverage) / 2;
                let confidenceClass = "green";
                let emoji = "üü¢";

                if (confidence < 0.7) {
                  confidenceClass = "red";
                  emoji = "üî¥";
                } else if (confidence < 0.85) {
                  confidenceClass = "yellow";
                  emoji = "üü°";
                }

                confidenceScore.className = `confidence-score show ${confidenceClass}`;
                confidenceScore.innerHTML = `
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5em;">${emoji}</span>
                    <div>
                      <div>Extraction Quality Score</div>
                      <div class="confidence-value">${(confidence * 100).toFixed(1)}%</div>
                    </div>
                  </div>
                  <div class="confidence-details">
                    <div class="confidence-detail">üìà <strong>BLEU Score:</strong> ${(eval_result.avg_bleu * 100).toFixed(1)}%</div>
                    <div class="confidence-detail">üì¶ <strong>Coverage:</strong> ${(eval_result.coverage * 100).toFixed(1)}%</div>
                    <div class="confidence-detail">üîë <strong>Fields Detected:</strong> ${eval_result.total_fields}</div>
                    <div class="confidence-detail">‚úì <strong>Fields Filled:</strong> ${eval_result.non_empty_fields}</div>
                  </div>
                `;
              }

              // Display n-gram metrics when done
              if (s.status === "done" && s.ngram_metrics) {
                const metrics = s.ngram_metrics;
                let ngramHtml = '<div class="table-section"><h3>üî§ N-gram Precision (Wording Fidelity)</h3><table><thead><tr><th>Field</th><th>1-gram</th><th>2-gram</th><th>3-gram</th><th>4-gram</th><th>Status</th></tr></thead><tbody>';
                for (const [key, m] of Object.entries(metrics)) {
                  const n4 = m['n4_precision'];
                  let status = n4 >= 0.9 ? '‚úÖ Exact' : n4 >= 0.75 ? '‚ö†Ô∏è Close' : '‚ùå Paraphrased';
                  ngramHtml += `<tr><td>${key}</td><td>${(m['n1_precision']*100).toFixed(0)}%</td><td>${(m['n2_precision']*100).toFixed(0)}%</td><td>${(m['n3_precision']*100).toFixed(0)}%</td><td>${(m['n4_precision']*100).toFixed(0)}%</td><td>${status}</td></tr>`;
                }
                ngramHtml += '</tbody></table></div>';
                tableContainer.innerHTML = ngramHtml;
              }

              // Display dataframe as table when done
              if (s.status === "done" && s.data) {
                clearInterval(iv);
                const data = s.data;
                let html = '<div class="table-section"><h3>üìä Extracted Data</h3><table><thead><tr>';

                if (data.length > 0) {
                  Object.keys(data[0]).forEach((col) => {
                    html += `<th>${col}</th>`;
                  });
                }
                html += "</tr></thead><tbody>";

                data.forEach((row) => {
                  html += "<tr>";
                  Object.values(row).forEach((val) => {
                    html += `<td>${val || ""}</td>`;
                  });
                  html += "</tr>";
                });

                html += "</tbody></table></div>";
                tableContainer.innerHTML += html;

                jobDiv.innerHTML += `
                  <a href="/download/${id}" class="download-link">‚¨áÔ∏è Download Excel</a>
                `;
              }

              if (s.status === "scanned") {
                clearInterval(iv);
                jobDiv.innerHTML = 'üö® Scanned PDF detected - OCR not supported';
                logsSection.classList.remove("show");
              }

              if (s.status === "error") {
                clearInterval(iv);
                jobDiv.innerHTML = '‚ùå Error during processing';
              }
            } catch (err) {
              console.error("Status check error:", err);
            }
          }, 1500);
        } catch (err) {
          jobDiv.innerHTML = "‚ùå Upload failed";
          console.error("Upload error:", err);
        }
      }
    </script>
  </body>
</html>
    <script>
      const form = document.getElementById("uploadForm");
      const logs = document.getElementById("logs");
      const jobDiv = document.getElementById("job");
      const tableContainer = document.getElementById("tableContainer");
      const confidenceScore = document.getElementById("confidenceScore");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const f = document.getElementById("file").files[0];
        if (!f) return alert("pick a pdf");
        const fd = new FormData();
        fd.append("file", f);
        const res = await fetch("/upload", { method: "POST", body: fd });
        const j = await res.json();
        jobDiv.innerText = "Job: " + j.job_id;
        tableContainer.innerHTML = "";
        confidenceScore.style.display = "none";

        // poll status
        const id = j.job_id;
        const iv = setInterval(async () => {
          const s = await (await fetch("/status/" + id)).json();
          logs.innerText = s.logs.join("\n");

          // Display confidence score when done
          if (s.status === "done" && s.eval_result) {
            const eval_result = s.eval_result;
            const confidence =
              (eval_result.avg_bleu + eval_result.coverage) / 2;
            let confidenceColor = "#4CAF50"; // green
            if (confidence < 0.7) confidenceColor = "#ff6b6b"; // red
            else if (confidence < 0.85) confidenceColor = "#ffa500"; // orange

            confidenceScore.style.display = "block";
            confidenceScore.style.borderLeftColor = confidenceColor;
            confidenceScore.innerHTML = `
              üìä Extraction Quality Score: <span style="color: ${confidenceColor}">${(
              confidence * 100
            ).toFixed(1)}%</span><br>
              <small>
                BLEU Score: ${(eval_result.avg_bleu * 100).toFixed(1)}% | 
                Coverage: ${(eval_result.coverage * 100).toFixed(1)}% | 
                Fields Detected: ${eval_result.total_fields} | 
                Fields with Values: ${eval_result.non_empty_fields}
              </small>
            `;
          }

          // Display dataframe as table when done
          if (s.status === "done" && s.data) {
            clearInterval(iv);
            const data = s.data;
            let html = "<h3>Extracted Data</h3><table><thead><tr>";

            // Header row
            if (data.length > 0) {
              Object.keys(data[0]).forEach((col) => {
                html += "<th>" + col + "</th>";
              });
            }
            html += "</tr></thead><tbody>";

            // Data rows
            data.forEach((row) => {
              html += "<tr>";
              Object.values(row).forEach((val) => {
                html += "<td>" + (val || "") + "</td>";
              });
              html += "</tr>";
            });

            html += "</tbody></table>";
            tableContainer.innerHTML = html;

            jobDiv.innerHTML +=
              ' | <a href="/download/' +
              id +
              '" style="text-decoration: none; color: blue;">Download Excel</a>';
          }
          if (s.status === "scanned" || s.status === "error") {
            clearInterval(iv);
          }
        }, 1500);
      });
    </script>
  </body>
</html>
